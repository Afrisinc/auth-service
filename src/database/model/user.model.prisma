enum AccountType {
  INDIVIDUAL
  ORGANIZATION
}
enum UserStatus {
  ACTIVE
  INACTIVE
  DORMANT
  CLOSED
  SUSPENDED
}

enum ProductStatus {
  PROVISIONING
  ACTIVE
  SUSPENDED
}

enum ProductPlan {
  FREE
  PRO
  ENTERPRISE
}

enum OrganizationMemberRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password_hash     String
  firstName         String?
  lastName          String?
  phone             String?
  location          String?
  status            UserStatus    @default(ACTIVE)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  accounts          Account[]
  organizationMembers OrganizationMember[]
  loginEvents       LoginEvent[]
  loginFailures     LoginFailure[]    @relation("LoginFailures")
  tokens            Token[]           @relation("Tokens")

  @@map("users")
}

model Organization {
  id                String    @id @default(uuid())
  name              String
  legal_name        String?
  country           String?
  tax_id            String?
  org_email         String?
  org_phone         String?
  location          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  members           OrganizationMember[]
  accounts          Account[]

  @@map("organizations")
}

model OrganizationMember {
  id                String    @id @default(uuid())
  organization_id   String
  user_id           String
  role              OrganizationMemberRole
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user              User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, user_id])
  @@map("organization_members")
}

model Account {
  id                String    @id @default(uuid())
  type              AccountType
  owner_user_id     String
  organization_id   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  owner             User @relation(fields: [owner_user_id], references: [id], onDelete: Cascade)
  organization      Organization? @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  products          AccountProduct[]

  @@index([owner_user_id])
  @@index([organization_id])
  @@map("accounts")
}

model Product {
  id                String    @id @default(uuid())
  name              String
  code              String    @unique
  description       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  accounts          AccountProduct[]

  @@map("products")
}

model AccountProduct {
  id                String    @id @default(uuid())
  account_id        String
  product_id        String
  status            ProductStatus @default(ACTIVE)
  plan              ProductPlan @default(FREE)
  external_resource_id String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  account           Account @relation(fields: [account_id], references: [id], onDelete: Cascade)
  product           Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([account_id, product_id])
  @@index([account_id])
  @@index([product_id])
  @@map("account_products")
}

model LoginEvent {
  id        String    @id @default(uuid())
  user_id   String
  status    String    // success | failed
  ip        String?
  createdAt DateTime  @default(now())

  // Relations
  user      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([createdAt])
  @@index([status])
  @@map("login_events")
}

model LoginFailure {
  id              String    @id @default(uuid())
  email           String
  ip_address      String
  failure_reason  String    // "Invalid password", "Account locked", "MFA failed", "Expired token"
  user_id         String?
  session_id      String?
  createdAt       DateTime  @default(now())

  // Relations
  user            User?     @relation("LoginFailures", fields: [user_id], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([ip_address])
  @@index([email])
  @@index([user_id])
  @@index([ip_address, createdAt])
  @@index([email, createdAt])
  @@map("login_failures")
}

model Token {
  id              String    @id @default(uuid())
  user_id         String
  token_type      String    // "access", "refresh", "api_key"
  issued_at       DateTime  @default(now())
  expires_at      DateTime?
  revoked_at      DateTime?

  // Relations
  user            User      @relation("Tokens", fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([issued_at])
  @@index([user_id, issued_at])
  @@map("tokens")
}
